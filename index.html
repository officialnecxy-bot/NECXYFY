<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NECXYFY - Ultimate Edition</title>
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #ff0055; /* Neon Red */
            --secondary: #00ffff; /* Cyber Blue */
            --bg: #050505;
            --surface: #0a0a0a;
            --glass: rgba(255, 255, 255, 0.05);
            --border: 1px solid rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --player-h: 90px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg); color: var(--text);
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* --- START OVERLAY (To fix Audio Context) --- */
        #start-overlay {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .start-btn {
            padding: 20px 50px; font-size: 1.5rem; font-family: 'Rajdhani'; font-weight: 700;
            color: white; background: transparent; border: 2px solid var(--primary);
            box-shadow: 0 0 20px var(--primary); border-radius: 50px; cursor: pointer;
            animation: pulse 2s infinite; text-transform: uppercase; letter-spacing: 2px;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 10px var(--primary); } 50% { box-shadow: 0 0 30px var(--primary); } 100% { box-shadow: 0 0 10px var(--primary); } }

        /* --- LAYOUT --- */
        #app { display: flex; height: calc(100% - var(--player-h)); }

        /* SIDEBAR */
        aside {
            width: 260px; background: var(--surface); border-right: var(--border);
            display: flex; flex-direction: column; padding: 20px; z-index: 10;
        }
        .brand { 
            font-family: 'Rajdhani', sans-serif; font-size: 2rem; font-weight: 700; 
            color: white; text-shadow: 0 0 10px var(--primary); margin-bottom: 30px;
            display: flex; align-items: center; gap: 10px;
        }
        .brand span { color: var(--primary); }

        .nav-item {
            padding: 14px; border-radius: 8px; color: #888; cursor: pointer;
            display: flex; align-items: center; gap: 15px; transition: 0.2s; font-weight: 600;
        }
        .nav-item:hover, .nav-item.active { background: rgba(255, 0, 85, 0.1); color: white; border-left: 3px solid var(--primary); }
        
        /* MAIN AREA */
        main {
            flex: 1; background: radial-gradient(circle at 50% 0%, #1a0505 0%, #000000 100%);
            overflow-y: auto; padding: 20px; position: relative;
        }
        
        /* SEARCH */
        .search-container {
            display: flex; gap: 10px; margin-bottom: 20px; position: sticky; top: 0; z-index: 20;
        }
        #search-in {
            flex: 1; background: rgba(0,0,0,0.8); border: 1px solid #333; padding: 15px;
            border-radius: 10px; color: white; backdrop-filter: blur(10px); font-family: 'Outfit';
        }
        .btn-action {
            width: 50px; background: var(--primary); border: none; color: white;
            border-radius: 10px; cursor: pointer; font-size: 1.2rem;
            box-shadow: 0 0 15px rgba(255, 0, 85, 0.4);
        }

        /* GRID */
        .section-title { font-family: 'Rajdhani'; font-size: 1.5rem; margin-bottom: 15px; color: var(--secondary); }
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px;
            padding-bottom: 50px;
        }
        .card {
            background: #111; padding: 15px; border-radius: 15px; border: 1px solid #222;
            cursor: pointer; transition: 0.3s; position: relative;
        }
        .card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 20px rgba(255, 0, 85, 0.2);
        }
        .card-img { width: 100%; aspect-ratio: 1/1; border-radius: 10px; object-fit: cover; margin-bottom: 10px; }
        .card-title { font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; }
        .card-sub { font-size: 0.75rem; color: #777; }
        
        .play-overlay {
            position: absolute; bottom: 15px; right: 15px; width: 40px; height: 40px;
            background: var(--primary); border-radius: 50%; display: flex; align-items: center;
            justify-content: center; opacity: 0; transform: translateY(10px); transition: 0.3s;
        }
        .card:hover .play-overlay { opacity: 1; transform: translateY(0); }

        /* PLAYER BAR */
        #player {
            height: var(--player-h); background: #090909; border-top: 1px solid #222;
            display: flex; align-items: center; padding: 0 20px; justify-content: space-between;
            z-index: 100;
        }
        .p-info { display: flex; align-items: center; gap: 15px; width: 30%; }
        .p-thumb { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        
        .p-controls { display: flex; flex-direction: column; align-items: center; width: 40%; gap: 5px; }
        .btns { display: flex; align-items: center; gap: 20px; }
        .btn-p { background: none; border: none; color: #ccc; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
        .btn-p:hover { color: var(--primary); }
        .btn-play { 
            width: 45px; height: 45px; background: white; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; font-size: 1.2rem; color: black;
        }
        
        .seek-wrap { width: 100%; display: flex; align-items: center; gap: 10px; font-size: 0.7rem; color: #666; font-family: monospace; }
        .rail { flex: 1; height: 4px; background: #333; border-radius: 2px; cursor: pointer; position: relative; }
        .fill { width: 0%; height: 100%; background: var(--secondary); border-radius: 2px; box-shadow: 0 0 10px var(--secondary); }

        /* VISUALIZER */
        #viz { position: absolute; bottom: 0; left: 0; width: 100%; height: 300px; pointer-events: none; opacity: 0.3; z-index: 0; }

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            #app { flex-direction: column; }
            aside { width: 100%; height: auto; padding: 10px; flex-direction: row; justify-content: space-around; align-items: center; background: #000; border-bottom: 1px solid #222; }
            .brand, .nav-item span { display: none; }
            .nav-item { padding: 8px; }
            .nav-item i { font-size: 1.4rem; }
            .p-right { display: none; }
            .p-info { width: 60%; }
            .p-controls { width: 40%; }
            #player { height: 80px; }
        }

        /* MODALS */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-bg.active { display: flex; }
        .modal { background: #111; padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; border: 1px solid #333; text-align: center; }
        .btn-full { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; font-weight: 700; cursor: pointer; margin-top: 15px; }
        
        #reader { width: 100%; border-radius: 10px; overflow: hidden; background: black; }
    </style>
</head>
<body>

<div id="start-overlay">
    <div style="font-size:3rem; margin-bottom:20px; color:var(--primary);">ðŸŽ§</div>
    <div style="color:white; margin-bottom:30px; text-align:center;">
        <h2>NECXYFY</h2>
        <p style="color:#888;">Music Engine Loaded</p>
    </div>
    <button class="start-btn" onclick="app.start()">ENTER APP</button>
</div>

<div id="app">
    <aside>
        <div class="brand"><i class="fa-solid fa-bolt"></i> NECXY<span>FY</span></div>
        <div class="nav-item active" onclick="app.loadHome()"><i class="fa-solid fa-fire"></i> <span>Trending</span></div>
        <div class="nav-item" onclick="document.getElementById('search-in').focus()"><i class="fa-solid fa-search"></i> <span>Search</span></div>
        <div class="nav-item" onclick="ui.modal('connect', true)"><i class="fa-solid fa-users"></i> <span>Watch Party</span></div>
        <div class="nav-item" onclick="document.getElementById('local').click()"><i class="fa-solid fa-folder"></i> <span>My Files</span></div>
        <input type="file" id="local" style="display:none" accept="audio/*" onchange="player.playLocal(this.files[0])">
    </aside>

    <main>
        <canvas id="viz"></canvas>
        
        <div class="search-container">
            <input type="text" id="search-in" placeholder="Search song..." onkeypress="if(event.key==='Enter') app.search()">
            <button class="btn-action" onclick="app.search()"><i class="fa-solid fa-arrow-right"></i></button>
        </div>

        <div class="section-title" id="grid-title">Top Charts</div>
        <div class="grid" id="grid">
            </div>
    </main>
</div>

<div id="player">
    <div class="p-info">
        <img src="https://cdn-icons-png.flaticon.com/512/3075/3075908.png" id="p-img" class="p-thumb">
        <div style="overflow:hidden;">
            <h4 id="p-title" style="color:white; margin-bottom:3px; white-space:nowrap;">Select Song</h4>
            <p id="p-artist" style="color:#777; font-size:0.75rem;">Waiting...</p>
        </div>
    </div>
    <div class="p-controls">
        <div class="btns">
            <button class="btn-p" onclick="player.seek(-10)"><i class="fa-solid fa-backward"></i></button>
            <button class="btn-play" onclick="player.toggle()"><i class="fa-solid fa-play" id="play-icon"></i></button>
            <button class="btn-p" onclick="player.seek(10)"><i class="fa-solid fa-forward"></i></button>
        </div>
        <div class="seek-wrap">
            <span id="curr">0:00</span>
            <div class="rail" onclick="player.seekTo(event)"><div class="fill" id="fill"></div></div>
            <span id="dur">0:00</span>
        </div>
    </div>
    <div class="p-right" style="width:30%; display:flex; justify-content:flex-end; gap:15px; align-items:center;">
        <div style="font-size:0.8rem; color:var(--secondary); font-family:monospace;" id="conn-stat">OFFLINE</div>
        <button class="btn-p" onclick="ui.modal('connect', true)"><i class="fa-solid fa-link"></i></button>
    </div>
</div>

<div id="modal-connect" class="modal-bg">
    <div class="modal">
        <h3>MULTIPLAYER</h3>
        <p style="color:#666; font-size:0.8rem; margin:10px 0;">YOUR ID</p>
        <div style="background:#000; padding:10px; color:var(--secondary); font-family:monospace; margin-bottom:15px; border:1px dashed #333;" id="my-id">...</div>
        <input type="text" id="peer-id" placeholder="Friend ID" style="width:100%; padding:10px; background:#222; border:none; color:white; margin-bottom:10px;">
        <button class="btn-full" onclick="net.connect()">CONNECT</button>
        <div style="display:flex; gap:10px;">
            <button class="btn-full" style="background:#333; margin-top:10px;" onclick="ui.scanQR()">SCAN QR</button>
            <button class="btn-full" style="background:#333; margin-top:10px;" onclick="ui.modal('connect', false)">CLOSE</button>
        </div>
    </div>
</div>

<div id="modal-scanner" class="modal-bg">
    <div class="modal" style="padding:0; overflow:hidden;">
        <div id="reader"></div>
        <button class="btn-full" style="background:#333; margin:0; border-radius:0;" onclick="ui.stopScan()">CLOSE</button>
    </div>
</div>

<audio id="audio" crossorigin="anonymous"></audio>

<script>
    // --- RELIABLE MUSIC DATA (FAIL-SAFE) ---
    // This ensures music ALWAYS works even if API fails
    const HITS = [
        { title: "On & On", artist: "Cartoon", img: "https://i1.sndcdn.com/artworks-000122941074-j04543-t500x500.jpg", url: "https://nocopyrightsounds.co.uk/wp-content/uploads/2015/07/Cartoon-On-On-feat.-Daniel-Levi-NCS-Release.mp3" },
        { title: "Mortals", artist: "Warriyo", img: "https://i1.sndcdn.com/artworks-000194867909-5147l6-t500x500.jpg", url: "https://nocopyrightsounds.co.uk/wp-content/uploads/2021/09/Warriyo-Mortals-feat.-Laura-Brehm-NCS-Release.mp3" },
        { title: "Invincible", artist: "Deaf Kev", img: "https://i1.sndcdn.com/artworks-000115063076-061034-t500x500.jpg", url: "https://nocopyrightsounds.co.uk/wp-content/uploads/2015/05/DEAF-KEV-Invincible-NCS-Release.mp3" },
        { title: "Sky High", artist: "Elektronomia", img: "https://i1.sndcdn.com/artworks-000201292850-x31b6g-t500x500.jpg", url: "https://nocopyrightsounds.co.uk/wp-content/uploads/2016/12/Elektronomia-Sky-High-NCS-Release.mp3" },
        { title: "Heroes Tonight", artist: "Janji", img: "https://i1.sndcdn.com/artworks-000119893475-w5c621-t500x500.jpg", url: "https://nocopyrightsounds.co.uk/wp-content/uploads/2015/06/Janji-Heroes-Tonight-feat.-Johnning-NCS-Release.mp3" },
        { title: "Blank", artist: "Disfigure", img: "https://i1.sndcdn.com/artworks-000113164993-9q0m44-t500x500.jpg", url: "https://nocopyrightsounds.co.uk/wp-content/uploads/2013/01/Disfigure-Blank-NCS-Release.mp3" }
    ];

    // --- VARIABLES ---
    let peer, conn, isHost = false;
    let audioCtx, analyser, dataArray;
    let html5QrCode;
    const audio = document.getElementById('audio');

    // --- APP LOGIC ---
    const app = {
        start: () => {
            document.getElementById('start-overlay').style.display = 'none';
            vis.init(); // Unlock Audio Context
            app.loadHome();
        },
        loadHome: () => {
            document.getElementById('grid-title').innerText = "Trending & NCS Hits";
            app.render(HITS); // Load guaranteed songs
        },
        search: async () => {
            const query = document.getElementById('search-in').value;
            const grid = document.getElementById('grid');
            if(!query) return;
            
            grid.innerHTML = '<p style="color:#777; grid-column:1/-1; text-align:center;">Searching Cloud...</p>';
            
            try {
                // Try Official Saavn Wrapper (saavn.dev)
                const res = await fetch(`https://saavn.dev/api/search/songs?query=${encodeURIComponent(query)}`);
                const json = await res.json();
                
                if(!json.data || json.data.results.length === 0) throw new Error("API Empty");

                grid.innerHTML = '';
                json.data.results.forEach(song => {
                    // Extract Highest Quality
                    const img = song.image[2]?.link || song.image[0]?.link;
                    const url = song.downloadUrl[4]?.link || song.downloadUrl[2]?.link || song.downloadUrl[0]?.link;
                    
                    app.createCard({
                        title: song.name.replace(/&quot;/g,'"'),
                        artist: song.primaryArtists,
                        img: img,
                        url: url
                    });
                });
            } catch(e) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:red;">Network Restricted. Showing Offline Library.</div>';
                // Fallback to local hits if API fails
                setTimeout(() => app.render(HITS), 1000); 
            }
        },
        render: (list) => {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            list.forEach(song => app.createCard(song));
        },
        createCard: (song) => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <img src="${song.img}" class="card-img">
                <div class="play-overlay"><i class="fa-solid fa-play"></i></div>
                <div class="card-title">${song.title}</div>
                <div class="card-sub">${song.artist}</div>
            `;
            div.onclick = () => player.play(song.url, song.title, song.artist, song.img);
            document.getElementById('grid').appendChild(div);
        }
    };

    // --- PLAYER ---
    const player = {
        play: (url, title, artist, img) => {
            audio.src = url;
            audio.play().catch(e => console.log("Play failed", e));
            
            document.getElementById('p-title').innerText = title;
            document.getElementById('p-artist').innerText = artist;
            document.getElementById('p-img').src = img;
            document.getElementById('play-icon').className = 'fa-solid fa-pause';
            
            // Sync
            isHost = true;
            if(conn) conn.send({type: 'play', url, title, artist, img});
        },
        playLocal: (file) => {
            const url = URL.createObjectURL(file);
            player.play(url, file.name, "Local File", "https://cdn-icons-png.flaticon.com/512/3075/3075908.png");
        },
        toggle: () => {
            if(audio.paused) { 
                audio.play(); 
                document.getElementById('play-icon').className = 'fa-solid fa-pause';
                if(conn && isHost) conn.send({type:'sync', act:'play'});
            } else { 
                audio.pause(); 
                document.getElementById('play-icon').className = 'fa-solid fa-play';
                if(conn && isHost) conn.send({type:'sync', act:'pause'});
            }
        },
        seek: (s) => audio.currentTime += s,
        seekTo: (e) => {
            const rect = e.target.closest('.rail').getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            audio.currentTime = pos * audio.duration;
            if(conn && isHost) conn.send({type:'sync', act:'seek', time: audio.currentTime});
        }
    };

    audio.addEventListener('timeupdate', () => {
        const pct = (audio.currentTime / audio.duration) * 100;
        document.getElementById('fill').style.width = pct + '%';
        const fmt = t => { const m=Math.floor(t/60), s=Math.floor(t%60); return `${m}:${s<10?'0'+s:s}`; };
        document.getElementById('curr').innerText = fmt(audio.currentTime);
        document.getElementById('dur').innerText = fmt(audio.duration||0);
    });

    // --- VISUALIZER ---
    const vis = {
        init: () => {
            if(audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            const src = audioCtx.createMediaElementSource(audio);
            src.connect(analyser);
            analyser.connect(audioCtx.destination);
            analyser.fftSize = 128;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            vis.draw();
        },
        draw: () => {
            const cvs = document.getElementById('viz');
            const ctx = cvs.getContext('2d');
            cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight;
            
            analyser.getByteFrequencyData(dataArray);
            ctx.clearRect(0,0,cvs.width,cvs.height);
            
            const w = (cvs.width / dataArray.length) * 2;
            let x = 0;
            for(let i=0; i<dataArray.length; i++) {
                const h = dataArray[i] / 1.5;
                // Gradient Color
                ctx.fillStyle = `rgba(0, 255, 255, ${h/300})`;
                ctx.fillRect(x, cvs.height - h, w, h);
                x += w + 2;
            }
            requestAnimationFrame(vis.draw);
        }
    };

    // --- NETWORKING ---
    const net = {
        init: () => {
            const id = 'nx-' + Math.floor(Math.random()*9000+1000);
            peer = new Peer(id);
            peer.on('open', id => document.getElementById('my-id').innerText = id);
            peer.on('connection', c => net.setup(c));
        },
        connect: () => {
            const id = document.getElementById('peer-id').value;
            if(id) net.setup(peer.connect(id));
        },
        setup: (c) => {
            conn = c;
            ui.modal('connect', false);
            document.getElementById('conn-stat').innerText = "CONNECTED";
            document.getElementById('conn-stat').style.color = "#00ff88";

            conn.on('data', data => {
                if(data.type === 'play') player.play(data.url, data.title, data.artist, data.img);
                if(data.type === 'sync') {
                    if(data.act === 'play') { audio.play(); document.getElementById('play-icon').className='fa-solid fa-pause'; }
                    if(data.act === 'pause') { audio.pause(); document.getElementById('play-icon').className='fa-solid fa-play'; }
                    if(data.act === 'seek') audio.currentTime = data.time;
                }
            });
        }
    };

    const ui = {
        modal: (id, show) => document.getElementById('modal-'+id).classList.toggle('active', show),
        scanQR: () => {
            ui.modal('connect', false); ui.modal('scanner', true);
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                document.getElementById('peer-id').value = txt; ui.stopScan(); ui.modal('connect', true);
            });
        },
        stopScan: () => { if(html5QrCode) html5QrCode.stop().then(()=>html5QrCode.clear()); ui.modal('scanner', false); }
    };
    const core = { copy: () => navigator.clipboard.writeText(peer.id).then(()=>alert('ID Copied')) };

    net.init();

</script>
</body>
</html>
